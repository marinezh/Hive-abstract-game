(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();const v=document.querySelector("#popup-rules"),A=document.querySelector("#close-rules"),N=document.querySelector("#show-rules");N&&N.addEventListener("click",()=>{v.classList.remove("hidden")});A&&A.addEventListener("click",()=>{v.classList.add("hidden")});v&&v.addEventListener("click",r=>{r.target===v&&v.classList.add("hidden")});window.addEventListener("DOMContentLoaded",()=>{let r=document.getElementById("popup-overlay");r&&(r.classList.add("hidden"),r.innerHTML="")});function _(r){let e=document.getElementById("popup-overlay");e||(e=document.createElement("div"),e.id="popup-overlay",e.className="hidden",document.body.appendChild(e)),e.classList.remove("hidden"),e.innerHTML=`
    <div class="popup">
      <h2>${r} wins!</h2>
      <span id="close-popup">&times;</span>
    </div>
  `,e.onclick=t=>{const n=t.target;n&&n.id==="close-popup"&&(e.classList.add("hidden"),window.location.reload())}}class X{pieces=[];addPiece(e,t){e.position=t,this.pieces.push(e)}isEmpty(e){return!this.pieces.some(t=>t.position.q===e.q&&t.position.r===e.r)}neighbors(e){return[{q:1,r:0},{q:-1,r:0},{q:0,r:1},{q:0,r:-1},{q:1,r:-1},{q:-1,r:1}].map(n=>({q:e.q+n.q,r:e.r+n.r}))}isHiveIntact(e,t){if(this.pieces.length<=1)return!0;const n=new Map;for(const l of this.pieces){const u=`${l.position.q},${l.position.r}`;n.has(u)||n.set(u,[]),n.get(u).push(l)}const o=`${e.position.q},${e.position.r}`,s=`${t.q},${t.r}`;n.has(o)&&(n.set(o,n.get(o).filter(l=>l!==e)),n.get(o).length===0&&n.delete(o)),n.has(s)||n.set(s,[]),n.get(s).push(e);const i=Array.from(n.entries()).map(([l,u])=>({key:l,top:u[u.length-1]})).map(({key:l})=>l);if(i.length===0)return!0;const c=new Set,a=[i[0]];for(;a.length>0;){const l=a.pop();if(c.has(l))continue;c.add(l);const[u,m]=l.split(",").map(Number);this.neighbors({q:u,r:m}).forEach($=>{const h=`${$.q},${$.r}`;i.includes(h)&&!c.has(h)&&a.push(h)})}return c.size===i.length}stackHeight(e){return this.pieces.filter(t=>t.position.q===e.q&&t.position.r===e.r).length}getStackAt(e){return this.pieces.filter(t=>t.position.q===e.q&&t.position.r===e.r).sort((t,n)=>t.stackLevel-n.stackLevel)}updateStackLevelsAt(e){return this.getStackAt(e).length}directions(){return[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}]}addDir(e,t){return{q:e.q+t.q,r:e.r+t.r}}}class L{owner;position;stackLevel=0;constructor(e,t){this.owner=e,this.position=t}}_("White");class Y{board;currentPlayer;turnCount;constructor(){this.board=new X,this.currentPlayer="White",this.turnCount=1}nextTurn(){this.currentPlayer=this.currentPlayer==="White"?"Black":"White",this.turnCount++}placePiece(e,t){if(console.log("placePiece",t.q,t.r),e.owner!==this.currentPlayer||!this.board.isEmpty(t))return!1;if(this.board.pieces.length===0)return this.board.addPiece(e,t),!0;if(this.board.pieces.length===1)return this.board.neighbors(t).some(l=>!this.board.isEmpty(l))?(this.board.addPiece(e,t),!0):!1;const n=this.board.neighbors(t);let o=!1;for(const c of n){const a=this.board.pieces.find(l=>l.position.q===c.q&&l.position.r===c.r);if(a)if(a.owner===this.currentPlayer)o=!0;else return!1}if(!o)return!1;const s=this.board.pieces.filter(c=>c.owner===e.owner);return!s.some(c=>c.constructor.name==="QueenBee"||c.type==="bee")&&s.length>=3&&e.constructor.name!=="QueenBee"&&e.type!=="bee"?!1:(this.board.addPiece(e,t),this.board.updateStackLevelsAt(t),!0)}movePiece(e,t){if(e.owner!==this.currentPlayer)return!1;const n=e.legalMoves(this.board);if(!n.some(i=>i.q===t.q&&i.r===t.r))return console.log("Move failed: Not a legal move"),console.log("Legal moves:",n),console.log("Attempted move to:",t),!1;const s={...e.position};return this.board.pieces.length>2&&!(e.type==="beetle"&&e.stackLevel===0)&&(e.position=t,!this.board.isHiveIntact(e,t))?(e.position=s,console.log("Move failed: Hive not intact"),!1):(e.position=t,e.stackLevel=this.board.updateStackLevelsAt(t),!0)}checkWin(){const e=this.board.pieces.filter(t=>t.constructor.name==="QueenBee");for(const t of e)if(this.board.neighbors(t.position).every(s=>!this.board.isEmpty(s)))return t.owner==="White"?"Black":"White";return null}}const W={};function K(r){return`/Hive-abstract-game/assets/${r}`}function Q(r,e){const t=`${r}_${e}`;if(!W[t]){const n=new Image;n.src=K(`${r}_${e.toLowerCase()}.png`),W[t]=n}return W[t]}function D(r,e){r.forEach(t=>{const n=Q(t.type,t.color),{x:o,y:s,width:i,height:c}=t;n.complete&&n.naturalWidth>0&&e.drawImage(n,o,s,i,c)})}function R(r,e,t,n){const o=20*t,s=e-n*t-20*t,i=60*t,c=(n+10)*t;let a=i,l=i;const u=["bee","spider","beetle","hopper","ant"],m=r.filter(h=>h.color==="Black").sort((h,B)=>u.indexOf(h.type)-u.indexOf(B.type)),$=r.filter(h=>h.color==="White").sort((h,B)=>u.indexOf(h.type)-u.indexOf(B.type));m.forEach(h=>{h.x=o,h.y=a,h.width=n*t,h.height=n*t,a+=c}),$.forEach(h=>{h.x=s,h.y=l,h.width=n*t,h.height=n*t,l+=c})}function T(r,e,t){const n=(Math.sqrt(3)/3*r-.3333333333333333*e)/t,o=2/3*e/t;return j({q:n,r:o})}function j({q:r,r:e}){const t=-r-e;let n=Math.round(r),o=Math.round(e),s=Math.round(t);const i=Math.abs(n-r),c=Math.abs(o-e),a=Math.abs(s-t);return i>c&&i>a?n=-o-s:c>a&&(o=-n-s),{q:n,r:o}}function z(r,e,t){const n=r.neighbors(e),o=r.neighbors(t);return n.filter(s=>o.some(i=>i.q===s.q&&i.r===s.r))}function P(r,e,t){if(!r.isEmpty(t)||!r.neighbors(t).some(c=>!r.isEmpty(c)))return!1;const s=z(r,e,t);return!(s.length===2&&s.every(c=>!r.isEmpty(c)))}function G(r,e){const t=e.getStackAt(r.position);return t.length>0&&t[t.length-1]===r}class F extends L{type="bee";legalMoves(e){const t=this.position,n=e.neighbors(t),o=[];for(const s of n){if(!P(e,t,s))continue;e.isHiveIntact(this,s)&&o.push(s)}return o}}class Z extends L{type="beetle";legalMoves(e){const t=e.neighbors(this.position),n=[];for(const o of t){const s=e.isEmpty(o),i=e.stackHeight(this.position)>1;s?i?e.isHiveIntact(this,o)&&P(e,this.position,o)&&n.push(o):e.isHiveIntact(this,o)&&P(e,this.position,o)&&n.push(o):e.isHiveIntact(this,o)&&n.push(o)}return n}}class J extends L{type="spider";legalMoves(e){const t=[],n=new Set;n.add(`${this.position.q},${this.position.r}`);const o=(s,i)=>{if(i===3){t.push(s);return}for(const c of e.neighbors(s)){const a=`${c.q},${c.r}`;n.has(a)||e.isEmpty(c)&&P(e,s,c)&&e.isHiveIntact(this,c)&&(n.add(a),o(c,i+1),n.delete(a))}};return o(this.position,0),t}}class U extends L{type="hopper";legalMoves(e){const t=[];for(const o of e.directions()){let s=e.addDir(this.position,o),i=!1;for(;!e.isEmpty(s);)i=!0,s=e.addDir(s,o);if(i){if(Math.abs(s.q)>6||Math.abs(s.r)>6||Math.abs(s.q+s.r)>6||!e.isHiveIntact(this,s))continue;t.push(s)}}return t}}class V extends L{type="ant";legalMoves(e){const t=[],n=new Set;n.add(`${this.position.q},${this.position.r}`);const o=s=>{for(const i of e.neighbors(s)){const c=`${i.q},${i.r}`;n.has(c)||e.isEmpty(i)&&P(e,s,i)&&e.isHiveIntact(this,i)&&(n.add(c),t.push(i),o(i),n.delete(c))}};return o(this.position),t}}function ee(r,e,t){switch(r){case"bee":return new F(e,t);case"beetle":return new Z(e,t);case"spider":return new J(e,t);case"hopper":return new U(e,t);case"ant":return new V(e,t);default:return null}}const S={};function te(r){return`/Hive-abstract-game/assets/${r}`}function C(r,e){const t=`${r}_${e}`;if(!S[t]){const n=new Image;n.src=te(`${r}_${e.toLowerCase()}.png`),S[t]=n}return S[t]}class se{ctx;logicalWidth;logicalHeight;physicalWidth;physicalHeight;size;constructor(e,t=30){this.ctx=e.getContext("2d");const n=window.devicePixelRatio||1;this.physicalWidth=e.width,this.physicalHeight=e.height,this.logicalWidth=e.width/n,this.logicalHeight=e.height/n,this.size=t}clear(){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.physicalWidth,this.physicalHeight),this.ctx.restore()}hexToPixel(e,t){const n=this.logicalWidth/2,o=this.logicalHeight/2,s=Math.sqrt(3)*this.size*(e+t/2)+n,i=3/2*this.size*t+o;return{x:s,y:i}}drawBoard(e,t){for(let s=-6;s<=6;s++)for(let i=-6;i<=6;i++)if(Math.abs(s+i)<=6){const{x:c,y:a}=this.hexToPixel(s,i),l=t&&t.q===s&&t.r===i;this.drawHexCustom(c,a,this.size,l?"#ffe066":void 0)}const o=new Map;for(const s of e.pieces){const i=`${s.position.q},${s.position.r}`;o.has(i)||o.set(i,[]),o.get(i).push(s)}for(const s of o.values()){s.sort((i,c)=>i.stackLevel-c.stackLevel);for(const i of s)this.drawPiece(i)}}drawHexCustom(e,t,n,o="#ddd"){this.ctx.beginPath();for(let s=0;s<6;s++){const i=Math.PI/3*s+Math.PI/6,c=e+n*Math.cos(i),a=t+n*Math.sin(i);s===0?this.ctx.moveTo(c,a):this.ctx.lineTo(c,a)}this.ctx.closePath(),this.ctx.strokeStyle="#333",this.ctx.stroke(),this.ctx.fillStyle=o,this.ctx.fill()}drawPiece(e){const{q:t,r:n}=e.position,{x:o,y:s}=this.hexToPixel(t,n),i=this.size,c=e.type||e.constructor.name.toLowerCase(),a=C(c,e.owner);a.complete&&a.naturalWidth>0?this.ctx.drawImage(a,o-i*.9,s-i*.9,i*1.8,i*1.8):(this.ctx.beginPath(),this.ctx.arc(o,s,i*.8,0,2*Math.PI),this.ctx.fillStyle=e.owner==="White"?"#fff":"#000",this.ctx.fill(),this.ctx.strokeStyle=e.owner==="White"?"#000":"#fff",this.ctx.stroke())}}let I=[],k={x:0,y:0},y=[],d=null;const g=document.getElementById("hive-canvas");let x=null;const w=1e3,H=750,q=window.devicePixelRatio||1;g.width=w*q;g.height=H*q;g.style.width=w+"px";g.style.height=H+"px";const E=30,f=30,b=new se(g,f);b.ctx.setTransform(q,0,0,q,0,0);const p=new Y,ne=[{type:"bee",count:1},{type:"spider",count:2},{type:"beetle",count:2},{type:"hopper",count:3},{type:"ant",count:3}];let ie=0;function oe(){return`p_${ie++}`}function re(){y=[],["Black","White"].forEach(r=>{ne.forEach(({type:e,count:t})=>{for(let n=0;n<t;n++)y.push({id:oe(),x:0,y:0,type:e,color:r,width:E,height:E})})}),R(y,w,q,E)}function O(r,e){const t=e.getBoundingClientRect(),n=r.clientX-t.left,o=r.clientY-t.top;return{x:n,y:o}}g.addEventListener("click",r=>{const{x:e,y:t}=O(r,g),n=w/2,o=H/2;if(!d){for(let i=y.length-1;i>=0;i--){const c=y[i];if(e>=c.x&&e<=c.x+c.width&&t>=c.y&&t<=c.y+c.height){d={from:"bank",bankId:c.id,type:c.type,color:c.color};return}}const s=T(e-n,t-o,f);for(let i=p.board.pieces.length-1;i>=0;i--){const c=p.board.pieces[i];if(c.position.q===s.q&&c.position.r===s.r&&c.owner===p.currentPlayer&&G(c,p.board)){d={from:"board",ref:c},I=c.legalMoves(p.board),console.log("Selected from board:",d),console.log("Stack level:",d.ref.stackLevel),console.log("Type:",d.ref.type);return}}}if(d){const s=d,i=T(e-n,t-o,f);if(s.from==="bank"){if(Math.abs(i.q)>6||Math.abs(i.r)>6||Math.abs(i.q+i.r)>6){console.log("❌ Outside board bounds:",i),d=null,M();return}const l=ee(s.type,s.color,i);if(l&&p.placePiece(l,i)){const u=y.findIndex(m=>m.id===s.bankId);u!==-1&&(y.splice(u,1),R(y,w,q,E)),p.nextTurn()}}else s.from==="board"&&(p.movePiece(s.ref,i)?(console.log("Move successful"),p.nextTurn()):console.log("Move failed"));d=null,I=[],M(),document.getElementById("game-status").textContent=`Next move: ${p.currentPlayer}`;const c=p.checkWin();c&&(console.log(`Winner: ${c}`),_(c))}});g.addEventListener("mousemove",r=>{k=O(r,g);const{x:e,y:t}=O(r,g),n=w/2,o=H/2,s=T(e-n,t-o,f);(!x||x.q!==s.q||x.r!==s.r)&&(x=s,M())});g.addEventListener("mouseleave",()=>{x=null,M()});function ce(r,e,t){r.save(),r.fillStyle="rgba(0, 200, 0, 0.3)";const n=new Set,o=[];e.forEach(s=>{const i=`${s.q},${s.r}`;n.has(i)||(n.add(i),o.push(s))}),o.forEach(s=>{const{x:i,y:c}=t.hexToPixel(s.q,s.r);r.beginPath();for(let a=0;a<6;a++){const l=Math.PI/180*(60*a-30),u=i+f*Math.cos(l),m=c+f*Math.sin(l);a===0?r.moveTo(u,m):r.lineTo(u,m)}r.closePath(),r.fill()}),r.restore()}function M(){if(b.clear(),D(y,b.ctx),b.drawBoard(p.board,x),d&&d.from==="bank"){const r=b.ctx;let e=d.type.toLowerCase();const t=C(e,d.color);r.drawImage(t,k.x-f,k.y-f,f*2,f*2)}else if(d&&d.from==="board"){const r=b.ctx,e=d.ref.type,t=d.ref.owner,n=C(e,t);r.drawImage(n,k.x-f,k.y-f,f*2,f*2)}I.length>0&&ce(b.ctx,I,b)}re();M();document.getElementById("game-container")?.classList.remove("hidden");document.body.classList.add("ready");
